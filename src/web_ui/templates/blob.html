{% extends "repo_base.html" %}
{% block title %}{{ file_name }} - {{ full_name }} - OpenXet{% endblock %}

{% block breadcrumb_extra %}
 / <a href="/{{ full_name }}?tab=files&branch={{ ref_name }}">{{ ref_name }}</a>
{% for crumb in breadcrumbs %} / {% if loop.last %}{{ crumb.name }}{% else %}<a href="/{{ full_name }}/tree/{{ ref_name }}/{{ crumb.path }}">{{ crumb.name }}</a>{% endif %}{% endfor %}
{% endblock %}

{% block header_actions %}
{% if branches %}
<select name="branch" class="select" onchange="handleBranchChange(this.value)">
    {% for branch in branches %}
    <option value="{{ branch.name }}" {% if branch.name == ref_name %}selected{% endif %}>{{ branch.name }}</option>
    {% endfor %}
</select>
{% endif %}
{% endblock %}

{% block branch_change_handler %}
window.location.href = '/{{ full_name }}/blob/' + branch + '/{{ path }}';
{% endblock %}

{% block repo_content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<style>
    .code-view { overflow-x: auto; }
    .code-table { border-collapse: collapse; width: 100%; }
    .code-table td { padding: 0; vertical-align: top; }
    .line-numbers {
        text-align: right;
        padding: 6px 8px 6px 6px;
        color: var(--text-muted);
        user-select: none;
        font-family: 'SF Mono', Consolas, Monaco, monospace;
        font-size: 12px;
        line-height: 1.5;
        border-right: 1px solid var(--border);
        white-space: pre;
        width: 1%;
        min-width: 32px;
    }
    .code-content {
        padding: 6px 8px;
        font-family: 'SF Mono', Consolas, Monaco, monospace;
        font-size: 12px;
        line-height: 1.5;
    }
    .code-content pre { margin: 0; padding: 0; background: transparent !important; }
    .code-content code { padding: 0 !important; background: transparent !important; display: block; }
    .hljs { background: transparent !important; padding: 0 !important; }
</style>

<div class="card">
    <div class="file-header">
        <div class="flex items-center gap-2">
            <span>{{ file_name }}</span>
            {% if is_lfs %}
                {% if lfs_status == "chunked" %}<span class="badge badge-success">Xet</span>
                {% elif lfs_status == "processing" %}<span class="badge badge-warning">Processing</span>
                {% elif lfs_status == "raw" %}<span class="badge">LFS</span>
                {% else %}<span class="badge">LFS</span>{% endif %}
            {% endif %}
            <span class="text-muted text-sm">{{ size_display }}</span>
            {% if not is_lfs and not is_binary %}<span class="text-muted text-sm">{{ line_count }}L</span>{% endif %}
        </div>
        <div class="flex gap-2">
            {% if not is_lfs and not is_binary %}
            <a href="/{{ full_name }}/edit/{{ ref_name }}/{{ path }}" class="btn">Edit</a>
            {% endif %}
            {% if is_lfs and lfs_oid %}
            <a href="/{{ full_name }}.git/info/lfs/objects/{{ lfs_oid }}" class="btn btn-primary">Download</a>
            {% endif %}
        </div>
    </div>
    {% if is_binary %}
    <div class="empty" style="padding: 24px;">Binary file not shown</div>
    {% else %}
    <div class="code-view">
        <table class="code-table"><tr>
            <td class="line-numbers" id="line-nums"></td>
            <td class="code-content"><pre><code id="code-block">{{ content }}</code></pre></td>
        </tr></table>
    </div>
    {% endif %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
hljs.highlightAll();
var code = document.getElementById('code-block');
if (code) {
    var text = code.textContent;
    var lineCount = text.split('\n').length;
    if (text.endsWith('\n')) lineCount--;
    var nums = '';
    for (var i = 1; i <= lineCount; i++) nums += i + '\n';
    document.getElementById('line-nums').textContent = nums.trimEnd();
}
</script>
{% endblock %}
