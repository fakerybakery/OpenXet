{% extends "repo_base.html" %}
{% block title %}{% if is_new %}New File{% else %}Edit {{ file_name }}{% endif %} - {{ full_name }} - OpenXet{% endblock %}

{% block breadcrumb_extra %}
 / <a href="/{{ full_name }}?tab=files&branch={{ ref_name }}">{{ ref_name }}</a>
{% if not is_new %}{% for crumb in breadcrumbs %} / {% if loop.last %}{{ crumb.name }}{% else %}<a href="/{{ full_name }}/tree/{{ ref_name }}/{{ crumb.path }}">{{ crumb.name }}</a>{% endif %}{% endfor %}{% endif %}
{% endblock %}

{% block header_actions %}
{# No branch selector in edit mode #}
{% endblock %}

{% block repo_content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
<style>
    .CodeMirror {
        height: auto;
        min-height: 400px;
        font-family: 'SF Mono', Consolas, Monaco, monospace;
        font-size: 12px;
        border: none;
        background: var(--bg-surface);
    }
    .CodeMirror-scroll { min-height: 400px; }
    .CodeMirror-gutters { background: var(--bg-surface); border-right: 1px solid var(--border); }
</style>

<div class="flex items-center justify-between mb-3">
    <h3 style="font-size: 16px; font-weight: 500;">{% if is_new %}New file{% else %}Editing {{ file_name }}{% endif %}</h3>
</div>

<form method="POST" action="/{{ full_name }}/{% if is_new %}new{% else %}edit{% endif %}/{{ ref_name }}{% if path %}/{{ path }}{% endif %}" id="edit-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="card">
        <div class="file-header">
            <input type="text" name="filename" class="input" style="flex: 1; max-width: 400px;" value="{{ path }}" placeholder="path/to/file.txt" />
        </div>
        <textarea name="content" id="editor">{{ content }}</textarea>
        <div class="file-header" style="border-top: 1px solid var(--border); border-bottom: none;">
            <input type="text" name="message" class="input" placeholder="Commit message (optional)" style="flex: 1;" />
            <div class="flex gap-2">
                {% if is_new %}
                <a href="/{{ full_name }}?tab=files&branch={{ ref_name }}" class="btn">Cancel</a>
                {% else %}
                <a href="/{{ full_name }}/blob/{{ ref_name }}/{{ path }}" class="btn">Cancel</a>
                {% endif %}
                <button type="submit" class="btn btn-primary">Commit</button>
            </div>
        </div>
    </div>
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/rust/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/toml/toml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script>
(function() {
    var filenameInput = document.querySelector('input[name="filename"]');
    var modeMap = {
        'js': 'javascript', 'jsx': 'javascript', 'ts': 'javascript', 'tsx': 'javascript', 'json': 'javascript',
        'py': 'python', 'rs': 'rust',
        'md': 'markdown', 'markdown': 'markdown', 'mdown': 'markdown', 'mkd': 'markdown',
        'html': 'htmlmixed', 'htm': 'htmlmixed',
        'css': 'css', 'scss': 'css', 'less': 'css',
        'xml': 'xml', 'svg': 'xml',
        'yml': 'yaml', 'yaml': 'yaml', 'toml': 'toml',
        'sh': 'shell', 'bash': 'shell', 'zsh': 'shell', 'go': 'go',
        'c': 'clike', 'h': 'clike', 'cpp': 'clike', 'hpp': 'clike', 'java': 'clike', 'cs': 'clike',
        'sql': 'sql'
    };

    function getMode(filename) {
        var ext = filename.split('.').pop().toLowerCase();
        return modeMap[ext] || 'text';
    }

    var editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: getMode(filenameInput.value),
        theme: 'material-darker',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        viewportMargin: Infinity
    });

    filenameInput.addEventListener('input', function() {
        editor.setOption('mode', getMode(this.value));
    });
})();
</script>
{% endblock %}
