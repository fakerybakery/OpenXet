{% extends "repo_base.html" %}
{% block title %}{{ repo_name }} - OpenXet{% endblock %}

{% include "components/dropdown.html" %}
{% include "components/modal.html" %}

{% block header_actions %}
<div class="flex items-center gap-2">
    {% if current_user %}
    <button type="button" id="star-btn" class="btn btn-sm" style="gap: 4px;" onclick="toggleStar()">
        <svg id="star-icon" class="icon-sm" viewBox="0 0 16 16" fill="currentColor" {% if user_has_liked %}style="color: var(--warning);"{% endif %}>
            {% if user_has_liked %}
            <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/>
            {% else %}
            <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z"/>
            {% endif %}
        </svg>
        <span id="star-count">{{ like_count | default(value=0) }}</span>
    </button>
    {% else %}
    <span class="btn btn-sm" style="gap: 4px; cursor: default;">
        <svg class="icon-sm" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z"/>
        </svg>
        <span>{{ like_count | default(value=0) }}</span>
    </span>
    {% endif %}
    {% if branches %}
    <a href="/{{ full_name }}/new/{{ current_branch | default(value='main') }}" class="btn btn-sm">New File</a>

    <!-- Branch Picker Dropdown -->
    <div class="dropdown" id="branch-dropdown">
        <button type="button" class="dropdown-trigger" onclick="toggleDropdown('branch-dropdown')">
            <svg class="item-icon" viewBox="0 0 16 16" fill="currentColor">
                <path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.493 2.493 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25Zm-6 0a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Zm8.25-.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM4.25 12a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z"/>
            </svg>
            <span id="current-branch-label">{{ current_branch | default(value='main') }}</span>
            <svg class="dropdown-icon" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z"/>
            </svg>
        </button>
        <div class="dropdown-menu align-right">
            <div class="dropdown-search">
                <input type="text" id="branch-search" placeholder="Find or create a branch..." oninput="filterBranches(this.value)">
            </div>
            <div class="dropdown-header">Branches</div>
            <div id="branch-list">
                {% for branch in branches %}
                <a href="#" class="dropdown-item branch-option {% if branch.name == current_branch %}active{% endif %}" data-branch="{{ branch.name }}" onclick="selectBranch('{{ branch.name }}'); return false;">
                    <span class="item-label">{{ branch.name }}</span>
                </a>
                {% endfor %}
            </div>
            {% if can_write %}
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item" onclick="showNewBranchModal(); closeAllDropdowns(); return false;">
                <svg class="item-icon" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M7.75 2a.75.75 0 0 1 .75.75V7h4.25a.75.75 0 0 1 0 1.5H8.5v4.25a.75.75 0 0 1-1.5 0V8.5H2.75a.75.75 0 0 1 0-1.5H7V2.75A.75.75 0 0 1 7.75 2Z"/>
                </svg>
                <span class="item-label">Create new branch</span>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block repo_content %}
{% if active_tab == "overview" %}
<div class="card mb-3">
    <div class="card-header">Clone</div>
    <div class="card-body">
        <code class="font-mono">git clone http://localhost:8080/{{ full_name }}.git</code>
    </div>
</div>

{% if readme_html %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<div class="card">
    <div class="card-header">README</div>
    <div class="readme">{{ readme_html | safe }}</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
document.querySelectorAll('.readme pre code').forEach(function(block) {
    hljs.highlightElement(block);
});
</script>
{% endif %}

{% if not readme_html and not branches %}
<div class="card">
    <div class="empty">
        <p class="mb-2">Empty repository</p>
        <p class="text-sm text-secondary">Push some code to get started</p>
    </div>
</div>
{% endif %}

{% else %}
<!-- Files tab -->
<div class="card">
    {% if entries %}
    <ul class="list">
        {% for entry in entries %}
        <li class="list-item">
            {% if entry.is_dir %}
            <svg class="icon folder-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M1.75 2.5a.25.25 0 00-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25v-8.5a.25.25 0 00-.25-.25H7.5c-.55 0-1.07-.26-1.4-.7l-.9-1.2a.25.25 0 00-.2-.1H1.75z"/></svg>
            <a href="/{{ full_name }}/tree/{{ current_branch }}/{{ entry.full_path }}">{{ entry.name }}</a>
            {% else %}
            <svg class="icon file-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M3.75 1.5a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h8.5a.25.25 0 00.25-.25V4.664a.25.25 0 00-.073-.177l-2.914-2.914a.25.25 0 00-.177-.073H3.75z"/></svg>
            <a href="/{{ full_name }}/blob/{{ current_branch }}/{{ entry.full_path }}">{{ entry.name }}</a>
            {% if entry.is_lfs %}
                {% if entry.lfs_status == "chunked" %}<span class="badge badge-success">Xet</span>
                {% elif entry.lfs_status == "processing" %}<span class="badge badge-warning">Processing</span>
                {% elif entry.lfs_status == "raw" %}<span class="badge">LFS</span>
                {% else %}<span class="badge">LFS</span>{% endif %}
            {% endif %}
            {% endif %}
            {% if entry.lfs_size %}<span class="text-secondary text-sm ml-auto">{{ entry.lfs_size }}</span>{% endif %}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="empty">Empty repository</div>
    {% endif %}
</div>
{% endif %}

{% if can_write %}
<!-- New Branch Modal (only for users with write permission) -->
<div id="new-branch-modal" class="modal-backdrop" onclick="if(event.target===this) hideNewBranchModal();">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Create new branch</span>
            <button type="button" class="modal-close" onclick="hideNewBranchModal()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"/>
                </svg>
            </button>
        </div>
        <form id="new-branch-form" method="POST" action="/{{ full_name }}/branches/new">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="source_branch" id="source-branch-input" value="{{ current_branch | default(value='main') }}">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Source branch</label>
                    <div class="form-static" id="source-branch-display">{{ current_branch | default(value='main') }}</div>
                </div>
                <div class="form-group">
                    <label class="form-label">New branch name</label>
                    <input type="text" name="branch_name" id="new-branch-name" required pattern="[a-zA-Z0-9._/-]+" class="input" placeholder="feature/my-branch">
                    <div class="form-hint">Use letters, numbers, dashes, underscores, and slashes</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideNewBranchModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create branch</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
var isStarred = {% if user_has_liked %}true{% else %}false{% endif %};
var csrfToken = '{{ csrf_token }}';
var repoName = '{{ full_name | safe }}';
var currentBranch = '{{ current_branch | default(value="main") }}';

// Branch filtering
function filterBranches(query) {
    var items = document.querySelectorAll('#branch-list .branch-option');
    var q = query.toLowerCase();
    items.forEach(function(item) {
        var branch = item.getAttribute('data-branch').toLowerCase();
        item.style.display = branch.includes(q) ? '' : 'none';
    });
}

// Branch selection
function selectBranch(branch) {
    closeAllDropdowns();
    window.location.href = '/' + repoName + '?tab={{ active_tab | default(value="overview") }}&branch=' + encodeURIComponent(branch);
}

// Star functionality
function toggleStar() {
    var btn = document.getElementById('star-btn');
    var icon = document.getElementById('star-icon');
    var count = document.getElementById('star-count');

    btn.disabled = true;

    var action = isStarred ? 'unlike' : 'like';
    fetch('/' + repoName + '/' + action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
        },
        body: 'csrf_token=' + encodeURIComponent(csrfToken)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            isStarred = !isStarred;
            count.textContent = data.like_count;

            if (isStarred) {
                icon.style.color = 'var(--warning)';
                icon.innerHTML = '<path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/>';
            } else {
                icon.style.color = '';
                icon.innerHTML = '<path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z"/>';
            }
        }
    })
    .catch(function(err) { console.error('Star error:', err); })
    .finally(function() { btn.disabled = false; });
}

// New branch modal helpers
function showNewBranchModal() {
    document.getElementById('source-branch-input').value = currentBranch;
    document.getElementById('source-branch-display').textContent = currentBranch;
    openModal('new-branch-modal');
}

function hideNewBranchModal() {
    closeModal('new-branch-modal');
}
</script>
{% endblock %}
